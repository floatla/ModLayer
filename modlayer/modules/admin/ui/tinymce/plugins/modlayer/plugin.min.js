
tinymce.PluginManager.add('modlayer', function(editor, url) {


	var options = editor.settings.modconf;

	/* 
		Add functionality for each module when is active
	*/

	// Related Images
	if(options.image)
	{
		editor.addButton('m_image', {
			tooltip:"Insertar Imagen",
			icon: "image",
			onclick: function() {
				window.appUI.OpenPanel(adminpath + '?m=image&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
			}
		});

		// Adds a menu item to the tools menu
		editor.addMenuItem('m_image', {
			icon: 'image',
			text: 'Insertar Imagen Relacionada',
			shortcut:"Meta+Shift+I",
			onclick: function(){
				window.appUI.OpenPanel(adminpath + '?m=image&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
			},
			context: 'insert',
			prependToContext: true
		});

		editor.addShortcut("Meta+Shift+I", "", function(){
			window.appUI.OpenPanel(adminpath + '?m=image&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
		});
	}

	 // Related Clips
	if(options.clip)
	{
		editor.addButton('m_clip', {
			tooltip:"Insertar Clip",
			icon: "clip",
			onclick: function() {
				window.appUI.OpenPanel(adminpath + '?m=clip&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&type_id='+editor.settings.item_typeid+'&module='+module);
			}
		});

		editor.addMenuItem('m_clip', {
			icon: 'clip',
			text: 'Clip Relacionado',
			shortcut:"Meta+Shift+C",
			onclick: function(){
				window.appUI.OpenPanel(adminpath + '?m=clip&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&type_id='+editor.settings.item_typeid+'&module='+module);
			},
			context: 'insert',
			prependToContext: true
		});

		editor.addShortcut("Meta+Shift+c", "", function(){
			window.appUI.OpenPanel(adminpath + '?m=clip&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&type_id='+editor.settings.item_typeid+'&module='+module);
		});
	}

	// Esternal code
	if(options.assets)
	{
		editor.addButton('m_assets', {
			tooltip:"Insertar Código Externo",
			icon: "asset",
			onclick: function() {
				window.appUI.OpenPanel(adminpath + '?m=article&action=DisplayAssets&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
			}
		});

		// Adds a menu item to the tools menu
		editor.addMenuItem('m_assets', {
			icon: 'asset',
			text: 'Código Externo (widget)',
			shortcut:"Meta+Shift+D",
			onclick: function(){
				window.appUI.OpenPanel(adminpath + '?m=article&action=DisplayAssets&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
			},
			context: 'insert',
			prependToContext: true
		});

		editor.addShortcut("Meta+Shift+d", "", function(){
			window.appUI.OpenPanel(adminpath + '?m=article&action=DisplayAssets&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
		});
	}

	// Related Audios
	if(options.audio)
	{
		editor.addButton('m_audio', {
			tooltip:"Insertar Audio",
			icon: "audio",
			onclick: function() {
				window.appUI.OpenPanel(adminpath + '?m=audio&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&type_id='+editor.settings.item_typeid+'&module='+module+'&height=window');
			}
		});

		// Adds a menu item to the tools menu
		editor.addMenuItem('m_audio', {
			icon: 'audio',
			text: 'Insertar Audio',
			onclick: function(){
				window.appUI.OpenPanel(adminpath + '?m=audio&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&type_id='+editor.settings.item_typeid+'&module='+module+'&height=window');
			},
			context: 'insert',
			prependToContext: true
		});
	}
	
	// Related Documents
	if(options.document)
	{
		editor.addButton('m_document', {
			tooltip:"Insertar Documento",
			icon: "document",
			onclick: function() {
				window.appUI.OpenPanel(adminpath + '?m=document&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&type_id='+editor.settings.item_typeid+'&module='+module+'&height=window');
			}
		});

		// Adds a menu item to the tools menu
		editor.addMenuItem('m_document', {
			icon: 'document',
			text: 'Insertar Documento',
			onclick: function(){
				window.appUI.OpenPanel(adminpath + '?m=document&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&type_id='+editor.settings.item_typeid+'&module='+module+'&height=window');
			},
			context: 'insert',
			prependToContext: true
		});
	}

	// Related Poll
	if(options.poll)
	{
		editor.addButton('m_poll', {
			tooltip:"Insertar Encuesta",
			icon: "poll",
			onclick: function() {
				window.appUI.OpenPanel(adminpath + '?m=poll&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
			}
		});

		// Adds a menu item to the tools menu
		editor.addMenuItem('m_poll', {
			icon: 'poll',
			text: 'Insertar Encuesta',
			onclick: function(){
				window.appUI.OpenPanel(adminpath + '?m=poll&action=RenderEmbedModal&item_id='+editor.settings.item_id+'&module='+module+'&height=window');
			},
			context: 'insert',
			prependToContext: true
		});
	}

	// System Autosave
	if(options.autosave)
	{
		var temp, interval,
		storage = tinymce.util.LocalStorage;

		function compare()
		{
			current = editor.getContent({format: "raw", no_events: !0});

			temp = storage.getItem('autosave-'+editor.id);
			if(current != temp){
				storage.setItem('autosave-'+editor.id, current);
				$('#'+editor.id).html(current);
				jsAutosave.save();
			}
		}

		editor.on("init", function() {
			storage.setItem('autosave-'+editor.id, editor.getContent({
	            	format: "raw",
	            	no_events: !0
	        	})
			);
			// interval = setInterval(function() {compare();}, 2000);
		});
		editor.on("blur", function() {
	        compare();
	    });
	}
});